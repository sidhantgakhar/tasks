<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome To-Do List</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* Light gray track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Medium gray thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Darker gray on hover */
        }
        .task-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Indigo to Violet */
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Light gray */
            color: #475569; /* Slate gray text */
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Slightly darker gray */
            transform: translateY(-1px);
        }
        .btn-delete {
            background-color: #ef4444; /* Red */
            transition: all 0.2s ease-in-out;
        }
        .btn-delete:hover {
            background-color: #dc2626; /* Darker red */
            transform: translateY(-1px);
        }
        .btn-edit {
            background-color: #3b82f6; /* Blue */
            transition: all 0.2s ease-in-out;
        }
        .btn-edit:hover {
            background-color: #2563eb; /* Darker blue */
            transform: translateY(-1px);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black overlay */
        }
        .modal-content {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Priority Matrix Specific Styles */
        .priority-quadrant {
            min-height: 200px; /* Ensure quadrants have some height */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #f8fafc; /* Lighter background for quadrants */
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .priority-quadrant-header {
            font-weight: 600;
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem; /* Gap between quadrants */
        }
        @media (min-width: 768px) {
            .matrix-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tab Selector Styles */
        .tab-selector-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        .tab-selector-button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            background-color: #e2e8f0; /* bg-gray-200 */
            color: #475569; /* text-gray-700 */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border: 1px solid transparent; /* default border */
        }
        .tab-selector-button:hover {
            background-color: #cbd5e1; /* hover:bg-gray-300 */
        }
        .tab-selector-button.selected {
            background-color: #6366f1; /* bg-indigo-500 */
            color: #ffffff; /* text-white */
            border-color: #4f46e5; /* darker indigo border */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 space-y-8">

        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">My To-Do List</h1>

        <!-- Task List Display (Priority Matrix) -->
        <div class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Tasks (Priority Matrix)</h2>
            <p class="text-center text-gray-500 mb-4" id="noTasksMessage">No tasks yet. Add one below!</p>

            <div class="matrix-grid">
                <!-- Quadrant 1: Do First (Urgent & Important) -->
                <div class="priority-quadrant border-red-500 border-2">
                    <h3 class="priority-quadrant-header text-red-700">Do First</h3>
                    <div id="quadrantUrgentImportant" class="space-y-4"></div>
                </div>

                <!-- Quadrant 3: Schedule (Not Urgent & Important) -->
                <div class="priority-quadrant border-blue-500 border-2">
                    <h3 class="priority-quadrant-header text-blue-700">Schedule</h3>
                    <div id="quadrantNotUrgentImportant" class="space-y-4"></div>
                </div>

                <!-- Quadrant 2: Delegate (Urgent & Not Important) -->
                <div class="priority-quadrant border-yellow-500 border-2">
                    <h3 class="priority-quadrant-header text-yellow-700">Delegate</h3>
                    <div id="quadrantUrgentNotImportant" class="space-y-4"></div>
                </div>

                <!-- Quadrant 4: Eliminate (Not Urgent & Not Important) -->
                <div class="priority-quadrant border-green-500 border-2">
                    <h3 class="priority-quadrant-header text-green-700">Eliminate</h3>
                    <div id="quadrantNotUrgentNotImportant" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Add New Task Form -->
        <form id="taskForm" class="space-y-6 bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Task</h2>

            <div>
                <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">Task Title <span class="text-red-500">*</span></label>
                <input type="text" id="taskTitle" name="taskTitle" required
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       placeholder="e.g., Finish project report">
            </div>

            <div>
                <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                <textarea id="taskDescription" name="taskDescription" rows="3"
                          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="Add more details about the task..."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Category Tabs -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category (Optional)</label>
                    <div id="taskCategoryTabs" class="tab-selector-group">
                        <button type="button" class="tab-selector-button" data-value="">None</button>
                        <button type="button" class="tab-selector-button" data-value="Work">Work</button>
                        <button type="button" class="tab-selector-button" data-value="Personal">Personal</button>
                        <button type="button" class="tab-selector-button" data-value="Personal Growth">Personal Growth</button>
                        <button type="button" class="tab-selector-button" data-value="Professional Growth">Professional Growth</button>
                        <button type="button" class="tab-selector-button" data-value="To Be Categorised">To Be Categorised</button>
                    </div>
                    <input type="hidden" id="taskCategory" name="taskCategory" value="">
                </div>

                <!-- Urgency Tabs -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Urgency (Optional)</label>
                    <div id="taskUrgencyTabs" class="tab-selector-group">
                        <button type="button" class="tab-selector-button" data-value="">None</button>
                        <button type="button" class="tab-selector-button" data-value="Urgent">Urgent</button>
                        <button type="button" class="tab-selector-button" data-value="Not Urgent">Not Urgent</button>
                    </div>
                    <input type="hidden" id="taskUrgency" name="taskUrgency" value="">
                </div>

                <!-- Importance Tabs -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Importance (Optional)</label>
                    <div id="taskImportanceTabs" class="tab-selector-group">
                        <button type="button" class="tab-selector-button" data-value="">None</button>
                        <button type="button" class="tab-selector-button" data-value="Important">Important</button>
                        <button type="button" class="tab-selector-button" data-value="Not Important">Not Important</button>
                    </div>
                    <input type="hidden" id="taskImportance" name="taskImportance" value="">
                </div>
            </div>

            <button type="submit" class="btn-primary w-full py-3 px-6 rounded-md text-white font-semibold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Add Task
            </button>
        </form>

        <!-- Export/Import Buttons -->
        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
            <button id="exportTasks" class="btn-secondary flex-1 py-3 px-6 rounded-md text-gray-700 font-semibold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                Export Tasks
            </button>
            <input type="file" id="importFile" accept=".json" class="hidden">
            <button id="importTasks" class="btn-secondary flex-1 py-3 px-6 rounded-md text-gray-700 font-semibold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus="ring-offset-2 focus:ring-gray-300">
                Import Tasks
            </button>
        </div>

    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-8 w-full max-w-md space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Edit Task</h2>

            <form id="editTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">

                <div>
                    <label for="editTaskTitle" class="block text-sm font-medium text-gray-700 mb-1">Task Title <span class="text-red-500">*</span></label>
                    <input type="text" id="editTaskTitle" name="editTaskTitle" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                    <textarea id="editTaskDescription" name="editTaskDescription" rows="3"
                              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>

                <!-- Edit Category Tabs -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category (Optional)</label>
                    <div id="editTaskCategoryTabs" class="tab-selector-group">
                        <button type="button" class="tab-selector-button" data-value="">None</button>
                        <button type="button" class="tab-selector-button" data-value="Work">Work</button>
                        <button type="button" class="tab-selector-button" data-value="Personal">Personal</button>
                        <button type="button" class="tab-selector-button" data-value="Personal Growth">Personal Growth</button>
                        <button type="button" class="tab-selector-button" data-value="Professional Growth">Professional Growth</button>
                        <button type="button" class="tab-selector-button" data-value="To Be Categorised">To Be Categorised</button>
                    </div>
                    <input type="hidden" id="editTaskCategory" name="editTaskCategory" value="">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Edit Urgency Tabs -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Urgency (Optional)</label>
                        <div id="editTaskUrgencyTabs" class="tab-selector-group">
                            <button type="button" class="tab-selector-button" data-value="">None</button>
                            <button type="button" class="tab-selector-button" data-value="Urgent">Urgent</button>
                            <button type="button" class="tab-selector-button" data-value="Not Urgent">Not Urgent</button>
                        </div>
                        <input type="hidden" id="editTaskUrgency" name="editTaskUrgency" value="">
                    </div>

                    <!-- Edit Importance Tabs -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Importance (Optional)</label>
                        <div id="editTaskImportanceTabs" class="tab-selector-group">
                            <button type="button" class="tab-selector-button" data-value="">None</button>
                            <button type="button" class="tab-selector-button" data-value="Important">Important</button>
                            <button type="button" class="tab-selector-button" data-value="Not Important">Not Important</button>
                        </div>
                        <input type="hidden" id="editTaskImportance" name="editTaskImportance" value="">
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelEdit" class="btn-secondary py-2 px-4 rounded-md text-gray-700 font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-md text-white font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Conflict Modal (New) -->
    <div id="importConflictModal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Import Conflict</h2>
            <p class="text-gray-700">You have existing tasks. How would you like to import the new tasks?</p>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="mergeTasksBtn" class="btn-primary py-2 px-4 rounded-md text-white font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Merge
                </button>
                <button type="button" id="replaceTasksBtn" class="btn-delete py-2 px-4 rounded-md text-white font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Replace
                </button>
                <button type="button" id="cancelImportBtn" class="btn-secondary py-2 px-4 rounded-md text-gray-700 font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <script>
        // Array to hold all tasks
        let tasks = [];

        // DOM elements for Add Task Form
        const taskForm = document.getElementById('taskForm');
        const taskTitleInput = document.getElementById('taskTitle');
        const taskCategoryHiddenInput = document.getElementById('taskCategory');
        const taskUrgencyHiddenInput = document.getElementById('taskUrgency');
        const taskImportanceHiddenInput = document.getElementById('taskImportance');

        // DOM elements for Edit Task Modal
        const editModal = document.getElementById('editModal');
        const editTaskForm = document.getElementById('editTaskForm');
        const editTaskCategoryHiddenInput = document.getElementById('editTaskCategory');
        const editTaskUrgencyHiddenInput = document.getElementById('editTaskUrgency');
        const editTaskImportanceHiddenInput = document.getElementById('editTaskImportance');

        // DOM elements for Matrix and other controls
        const taskList = document.getElementById('taskList'); // This now refers to the container for the matrix
        const noTasksMessage = document.getElementById('noTasksMessage');
        const cancelEditButton = document.getElementById('cancelEdit');
        const exportTasksButton = document.getElementById('exportTasks');
        const importTasksButton = document.getElementById('importTasks');
        const importFileInput = document.getElementById('importFile');

        // Quadrant elements
        const quadrantUrgentImportant = document.getElementById('quadrantUrgentImportant');
        const quadrantUrgentNotImportant = document.getElementById('quadrantUrgentNotImportant');
        const quadrantNotUrgentImportant = document.getElementById('quadrantNotUrgentImportant');
        const quadrantNotUrgentNotImportant = document.getElementById('quadrantNotUrgentNotImportant');

        // Define category colors mapping
        const categoryColors = {
            "Work": "border-blue-600",
            "Personal": "border-purple-600",
            "Personal Growth": "border-green-600",
            "Professional Growth": "border-teal-600",
            "To Be Categorised": "border-gray-600",
            "": "border-indigo-400", // Default color for 'None' or uncategorized
            "None": "border-indigo-400" // Explicit 'None' color
        };


        // --- Utility Functions ---

        /**
         * Generates a unique ID for tasks.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /**
         * Saves the current tasks array to local storage.
         */
        function saveTasks() {
            try {
                localStorage.setItem('todoTasks', JSON.stringify(tasks));
            } catch (e) {
                console.error("Error saving tasks to local storage:", e);
                showTemporaryMessage("Failed to save tasks. Your browser's local storage might be full or disabled.", 'error');
            }
        }

        /**
         * Loads tasks from local storage.
         */
        function loadTasks() {
            try {
                const storedTasks = localStorage.getItem('todoTasks');
                tasks = storedTasks ? JSON.parse(storedTasks) : [];
                renderTasks();
                setLastSelectedCategory(); // Set the last selected category on load
            } catch (e) {
                console.error("Error loading tasks from local storage:", e);
                showTemporaryMessage("Failed to load tasks from local storage. Data might be corrupted.", 'error');
                tasks = []; // Reset tasks if loading fails
                saveTasks(); // Clear potentially corrupted data
                renderTasks();
            }
        }

        /**
         * Sets the last selected category in the add task form.
         */
        function setLastSelectedCategory() {
            const lastCategory = localStorage.getItem('lastSelectedCategory');
            // Select the corresponding tab in the add form
            selectTab('taskCategoryTabs', lastCategory || '');
        }

        /**
         * Handles the selection of a tab in a tab group.
         * Updates the 'selected' class and the associated hidden input's value.
         * @param {string} tabGroupId - The ID of the div containing the tab buttons.
         * @param {string} valueToSelect - The data-value of the tab to select.
         */
        function selectTab(tabGroupId, valueToSelect) {
            const tabGroup = document.getElementById(tabGroupId);
            if (!tabGroup) return;

            const hiddenInput = document.getElementById(tabGroupId.replace('Tabs', '')); // e.g., 'taskCategory'
            if (!hiddenInput) return;

            const buttons = tabGroup.querySelectorAll('.tab-selector-button');
            buttons.forEach(button => {
                if (button.dataset.value === valueToSelect) {
                    button.classList.add('selected');
                    hiddenInput.value = valueToSelect;
                } else {
                    button.classList.remove('selected');
                }
            });
        }

        /**
         * Event listener for tab button clicks.
         * @param {Event} event - The click event.
         */
        function handleTabClick(event) {
            const clickedButton = event.target.closest('.tab-selector-button');
            if (!clickedButton) return;

            const tabGroup = clickedButton.closest('.tab-selector-group');
            if (!tabGroup) return;

            const tabGroupId = tabGroup.id;
            const valueToSelect = clickedButton.dataset.value;

            selectTab(tabGroupId, valueToSelect);
        }

        /**
         * Renders all tasks into the priority matrix quadrants.
         */
        function renderTasks() {
            // Clear all quadrants first
            quadrantUrgentImportant.innerHTML = '';
            quadrantUrgentNotImportant.innerHTML = '';
            quadrantNotUrgentImportant.innerHTML = '';
            quadrantNotUrgentNotImportant.innerHTML = '';

            if (tasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
                return;
            } else {
                noTasksMessage.classList.add('hidden');
            }

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.id = `task-${task.id}`;
                
                // Determine category border color
                const categoryBorderClass = categoryColors[task.category] || categoryColors["None"];

                taskCard.classList.add(
                    'task-card',
                    'bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'flex', 'flex-col', 'space-y-2',
                    'border-l-4', categoryBorderClass // Apply dynamic category border color
                );

                // Task Title
                const titleElement = document.createElement('h4');
                titleElement.classList.add('text-lg', 'font-semibold', 'text-gray-900');
                titleElement.textContent = task.title;
                taskCard.appendChild(titleElement);

                // Task Description (if present)
                if (task.description) {
                    const descriptionElement = document.createElement('p');
                    descriptionElement.classList.add('text-gray-700', 'text-sm');
                    descriptionElement.textContent = task.description;
                    taskCard.appendChild(descriptionElement);
                }

                // Metadata (Category only, Urgency and Importance are implied by quadrant)
                const metaDiv = document.createElement('div');
                metaDiv.classList.add('flex', 'flex-wrap', 'gap-2', 'text-xs', 'font-medium');

                if (task.category) {
                    const categorySpan = document.createElement('span');
                    categorySpan.classList.add('bg-blue-100', 'text-blue-800', 'px-2.5', 'py-0.5', 'rounded-full');
                    categorySpan.textContent = `Category: ${task.category}`;
                    metaDiv.appendChild(categorySpan);
                }
                if (metaDiv.children.length > 0) {
                    taskCard.appendChild(metaDiv);
                }

                // Actions (Edit, Delete)
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('flex', 'gap-2', 'mt-3', 'justify-end');

                const editButton = document.createElement('button');
                editButton.classList.add('btn-edit', 'py-1', 'px-3', 'rounded-md', 'text-white', 'font-medium', 'shadow-sm', 'hover:shadow-md', 'text-sm');
                editButton.textContent = 'Edit';
                editButton.onclick = () => openEditModal(task.id);
                actionsDiv.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn-delete', 'py-1', 'px-3', 'rounded-md', 'text-white', 'font-medium', 'shadow-sm', 'hover:shadow-md', 'text-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => showConfirmDialog('Delete Task', 'Are you sure you want to delete this task?', () => deleteTaskConfirmed(task.id));
                actionsDiv.appendChild(deleteButton);

                taskCard.appendChild(actionsDiv);

                // Determine which quadrant to append the task to
                const isUrgent = task.urgency === 'Urgent';
                const isImportant = task.importance === 'Important';

                if (isUrgent && isImportant) {
                    quadrantUrgentImportant.appendChild(taskCard);
                } else if (isUrgent && !isImportant) {
                    quadrantUrgentNotImportant.appendChild(taskCard);
                } else if (!isUrgent && isImportant) {
                    quadrantNotUrgentImportant.appendChild(taskCard);
                } else { // Default to Not Urgent & Not Important if values are null or not set
                    quadrantNotUrgentNotImportant.appendChild(taskCard);
                }
            });
        }

        /**
         * Adds a new task to the list.
         * @param {Event} event - The form submission event.
         */
        function addTask(event) {
            event.preventDefault(); // Prevent default form submission

            const title = taskTitleInput.value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const category = taskCategoryHiddenInput.value;
            const urgency = taskUrgencyHiddenInput.value;
            const importance = taskImportanceHiddenInput.value;

            if (!title) {
                showTemporaryMessage('Task title is required!', 'warning');
                return;
            }

            const newTask = {
                id: generateUniqueId(),
                title: title,
                description: description,
                category: category || null, // Store as null if empty
                urgency: urgency || null,   // Store as null if empty
                importance: importance || null, // Store as null if empty
                completed: false // Default completion status
            };

            tasks.unshift(newTask); // Add to the beginning of the array
            saveTasks();
            renderTasks();
            taskForm.reset(); // Clear the form
            // Save the last selected category
            localStorage.setItem('lastSelectedCategory', category || '');
            selectTab('taskCategoryTabs', category || ''); // Re-select the category tab
            selectTab('taskUrgencyTabs', ''); // Reset urgency tab
            selectTab('taskImportanceTabs', ''); // Reset importance tab
            taskTitleInput.focus(); // Keep focus on the title input for quick adding
        }

        /**
         * Deletes a task by its ID. This is the function called after confirmation.
         * @param {string} id - The ID of the task to delete.
         */
        function deleteTaskConfirmed(id) {
            tasks = tasks.filter(task => task.id !== id);
            saveTasks();
            renderTasks();
            showTemporaryMessage('Task deleted successfully!', 'success');
        }

        /**
         * Opens the edit modal and populates it with task data.
         * @param {string} id - The ID of the task to edit.
         */
        function openEditModal(id) {
            const taskToEdit = tasks.find(task => task.id === id);
            if (!taskToEdit) {
                console.error('Task not found for editing:', id);
                showTemporaryMessage('Error: Task not found for editing.', 'error');
                return;
            }

            document.getElementById('editTaskId').value = taskToEdit.id;
            document.getElementById('editTaskTitle').value = taskToEdit.title;
            document.getElementById('editTaskDescription').value = taskToEdit.description || '';

            // Select tabs in the edit modal
            selectTab('editTaskCategoryTabs', taskToEdit.category || '');
            selectTab('editTaskUrgencyTabs', taskToEdit.urgency || '');
            selectTab('editTaskImportanceTabs', taskToEdit.importance || '');

            editModal.classList.remove('hidden');
        }

        /**
         * Closes the edit modal.
         */
        function closeEditModal() {
            editModal.classList.add('hidden');
            editTaskForm.reset(); // Clear the edit form
        }

        /**
         * Saves changes made in the edit modal.
         * @param {Event} event - The form submission event.
         */
        function saveEditedTask(event) {
            event.preventDefault();

            const id = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();
            const category = editTaskCategoryHiddenInput.value;
            const urgency = editTaskUrgencyHiddenInput.value;
            const importance = editTaskImportanceHiddenInput.value;

            if (!title) {
                showTemporaryMessage('Task title cannot be empty!', 'warning');
                return;
            }

            const taskIndex = tasks.findIndex(task => task.id === id);
            if (taskIndex > -1) {
                tasks[taskIndex] = {
                    ...tasks[taskIndex], // Keep existing properties
                    title: title,
                    description: description || null,
                    category: category || null,
                    urgency: urgency || null,
                    importance: importance || null
                };
                saveTasks();
                renderTasks();
                closeEditModal();
                showTemporaryMessage('Task updated successfully!', 'success');
            } else {
                console.error('Task not found for saving changes:', id);
                showTemporaryMessage('Error: Task not found for saving changes.', 'error');
            }
        }

        /**
         * Exports tasks to a JSON file.
         */
        function exportTasks() {
            const dataStr = JSON.stringify(tasks, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'todo_tasks.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up
            showTemporaryMessage('Tasks exported successfully!', 'success');
        }

        /**
         * Imports tasks from a JSON file.
         * @param {Event} event - The file input change event.
         */
        function importTasks(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Basic validation for imported data
                    if (!Array.isArray(importedData) || !importedData.every(item => typeof item === 'object' && item.id && item.title)) {
                        showTemporaryMessage('Invalid JSON file format. Please ensure it contains an array of task objects with "id" and "title".', 'error');
                        return;
                    }

                    if (tasks.length > 0) {
                        // If existing tasks, ask user to merge or replace
                        showImportConflictDialog(importedData);
                    } else {
                        // No existing tasks, just import
                        tasks = importedData;
                        saveTasks();
                        renderTasks();
                        showTemporaryMessage('Tasks imported successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error parsing imported JSON:', error);
                    showTemporaryMessage('Failed to import tasks. Please ensure the file is a valid JSON.', 'error');
                }
            };
            reader.readAsText(file);
        }

        /**
         * Displays a temporary message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'warning', or 'error' for styling.
         */
        function showTemporaryMessage(message, type = 'info') {
            const messageBoxId = 'tempMessageBox';
            let messageBox = document.getElementById(messageBoxId);

            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = messageBoxId;
                messageBox.classList.add(
                    'fixed', 'bottom-4', 'right-4', 'p-4', 'rounded-lg', 'shadow-lg', 'text-white', 'text-sm', 'z-50',
                    'opacity-0', 'transition-opacity', 'duration-300', 'ease-out'
                );
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.className = ''; // Clear existing classes
            messageBox.classList.add(
                'fixed', 'bottom-4', 'right-4', 'p-4', 'rounded-lg', 'shadow-lg', 'text-white', 'text-sm', 'z-50',
                'opacity-0', 'transition-opacity', 'duration-300', 'ease-out'
            );

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-500');
                    break;
                case 'warning':
                    messageBox.classList.add('bg-yellow-500');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-500');
                    break;
                default:
                    messageBox.classList.add('bg-blue-500');
            }

            // Show and then hide after a delay
            setTimeout(() => {
                messageBox.classList.remove('opacity-0');
                messageBox.classList.add('opacity-100');
            }, 10); // Small delay to ensure transition plays

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                // Optional: remove element after transition to clean up DOM
                setTimeout(() => {
                    if (messageBox.parentNode) {
                        messageBox.parentNode.removeChild(messageBox);
                    }
                }, 300); // Match transition duration
            }, 3000); // Message visible for 3 seconds
        }

        /**
         * Shows a custom confirmation dialog.
         * @param {string} title - The title of the dialog.
         * @param {string} message - The message to display.
         * @param {Function} onConfirm - Callback function if user confirms.
         */
        function showConfirmDialog(title, message, onConfirm) {
            let confirmModal = document.getElementById('confirmModal');
            if (!confirmModal) {
                confirmModal = document.createElement('div');
                confirmModal.id = 'confirmModal';
                confirmModal.classList.add('modal', 'fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'p-4', 'z-50', 'hidden');
                confirmModal.innerHTML = `
                    <div class="modal-content bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm space-y-6">
                        <h2 class="text-2xl font-semibold text-gray-800" id="confirmTitle"></h2>
                        <p class="text-gray-700" id="confirmMessage"></p>
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" id="confirmCancel" class="btn-secondary py-2 px-4 rounded-md text-gray-700 font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                                Cancel
                            </button>
                            <button type="button" id="confirmProceed" class="btn-delete py-2 px-4 rounded-md text-white font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Confirm
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
            }

            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmModal.classList.remove('hidden');

            const confirmCancelBtn = document.getElementById('confirmCancel');
            const confirmProceedBtn = document.getElementById('confirmProceed');

            // Clear previous listeners to prevent multiple calls
            confirmCancelBtn.onclick = null;
            confirmProceedBtn.onclick = null;

            confirmCancelBtn.onclick = () => confirmModal.classList.add('hidden');
            confirmProceedBtn.onclick = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            };

            // Close if clicking outside
            confirmModal.onclick = (e) => {
                if (e.target === confirmModal) {
                    confirmModal.classList.add('hidden');
                }
            };
        }

        /**
         * Shows a custom dialog to handle import conflicts (merge or replace).
         * @param {Array} newTasks - The array of tasks from the imported file.
         */
        function showImportConflictDialog(newTasks) {
            let conflictModal = document.getElementById('importConflictModal');
            if (!conflictModal) {
                console.error("Import conflict modal HTML not found. Please ensure #importConflictModal exists in the HTML.");
                return;
            }

            conflictModal.classList.remove('hidden');

            const mergeBtn = document.getElementById('mergeTasksBtn');
            const replaceBtn = document.getElementById('replaceTasksBtn');
            const cancelBtn = document.getElementById('cancelImportBtn');

            // Clear previous listeners
            mergeBtn.onclick = null;
            replaceBtn.onclick = null;
            cancelBtn.onclick = null;

            mergeBtn.onclick = () => {
                mergeImportedTasks(newTasks);
                conflictModal.classList.add('hidden');
            };
            replaceBtn.onclick = () => {
                replaceImportedTasks(newTasks);
                conflictModal.classList.add('hidden');
            };
            cancelBtn.onclick = () => {
                conflictModal.classList.add('hidden');
                showTemporaryMessage('Task import cancelled.', 'info');
            };

            // Close if clicking outside
            conflictModal.onclick = (e) => {
                if (e.target === conflictModal) {
                    conflictModal.classList.add('hidden');
                    showTemporaryMessage('Task import cancelled.', 'info');
                }
            };
        }

        /**
         * Merges imported tasks with existing tasks.
         * Existing tasks with matching IDs are updated; new tasks are added.
         * @param {Array} newTasks - The tasks to merge.
         */
        function mergeImportedTasks(newTasks) {
            newTasks.forEach(newTask => {
                const existingIndex = tasks.findIndex(task => task.id === newTask.id);
                if (existingIndex > -1) {
                    // Update existing task with new properties, giving precedence to imported data
                    tasks[existingIndex] = { ...tasks[existingIndex], ...newTask };
                } else {
                    // Add new task to the beginning
                    tasks.unshift(newTask);
                }
            });
            saveTasks();
            renderTasks();
            showTemporaryMessage('Tasks merged successfully!', 'success');
        }

        /**
         * Replaces all existing tasks with the imported tasks, ensuring no duplicates
         * and giving precedence to imported tasks for conflicting IDs.
         * @param {Array} newTasks - The tasks to replace/merge with.
         */
        function replaceImportedTasks(newTasks) {
            const combinedTasksMap = new Map();

            // Add existing tasks to the map first
            tasks.forEach(task => {
                combinedTasksMap.set(task.id, task);
            });

            // Add new tasks to the map, overwriting existing ones if IDs conflict
            newTasks.forEach(newTask => {
                combinedTasksMap.set(newTask.id, newTask);
            });

            // Convert map values back to an array
            tasks = Array.from(combinedTasksMap.values());

            // Optionally, if a specific order is desired after replacement, sort here.
            // For now, Map iteration order is preserved (insertion order for unique keys).

            saveTasks();
            renderTasks();
            showTemporaryMessage('Tasks replaced (merged and deduplicated) successfully!', 'success');
        }


        // --- Event Listeners ---

        // Load tasks when the page loads
        window.onload = loadTasks;

        // Add task form submission
        taskForm.addEventListener('submit', addTask);

        // Enable Enter key to submit form for taskTitle input
        taskTitleInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default newline behavior in input
                addTask(event); // Call the add task function
            }
        });

        // Attach event listeners to tab groups for the add form
        document.getElementById('taskCategoryTabs').addEventListener('click', handleTabClick);
        document.getElementById('taskUrgencyTabs').addEventListener('click', handleTabClick);
        document.getElementById('taskImportanceTabs').addEventListener('click', handleTabClick);

        // Edit task form submission
        editTaskForm.addEventListener('submit', saveEditedTask);

        // Cancel edit button click
        cancelEditButton.addEventListener('click', closeEditModal);

        // Close modal when clicking outside of it
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                closeEditModal();
            }
        });

        // Attach event listeners to tab groups for the edit modal
        document.getElementById('editTaskCategoryTabs').addEventListener('click', handleTabClick);
        document.getElementById('editTaskUrgencyTabs').addEventListener('click', handleTabClick);
        document.getElementById('editTaskImportanceTabs').addEventListener('click', handleTabClick);


        // Export tasks button click
        exportTasksButton.addEventListener('click', exportTasks);

        // Import tasks button click (triggers hidden file input)
        importTasksButton.addEventListener('click', () => importFileInput.click());

        // Handle file selection for import
        importFileInput.addEventListener('change', importTasks);

    </script>
</body>
</html>
